#' Makes a download request from the server.
#'
#' This function downloads the results of an experiment.
#' 
#' @param sourceURL The source URL for the experiment
#' @param experimentName The experiment name as set in \code{settings.js}
#' @param destination The file to download. By default, all uploaded results are
#' saved in \code{default.csv}, which is the default file to download. 
#' @param auth Whether authentication is needed
#'
#' @return The downloaded data set as data frame
#' 
#' @export
#' 
downloadExperiment <- function(sourceURL, experimentName,
                                destination = "default.csv",
                               auth = FALSE){
    request <- checkAuthentication("makecsv", auth)
    res <- API.request(request = request$request,
                       params = list(
                           sourceurl = sourceURL,
                           experimentName = experimentName,
                           file = destination
                       ),
                auth = request$auth)
    read.table(text = res, header = TRUE)
}

#' Returns the list of destination files for an experiment.
#'
#' @param sourceURL The source URL for the experiment
#' @param experimentName The experiment name as set in \code{settings.js}
#' @param auth Whether authentication is needed
#'
#' @return The list of destinations
#' @export
getDestinations <- function(sourceURL, experimentName, auth = FALSE){
    request <- checkAuthentication("destinations", auth, 2)
    res <- API.request(request = request$request,
                       params = list(
                           sourceurl = sourceURL,
                           experimentName = experimentName
                       ),
                       auth = request$auth)
    tryCatch(
        retval <- jsonlite::fromJSON(res),
        error = function(cond){
            stop(res)
        }
    )
    retval
}

#' Requests the table of users from the server.
#'
#' @param sourceURL The source URL for the experiment
#' @param experimentName The experiment name as set in \code{settings.js}
#' @param auth Whether authentication is needed
#'
#' @return The table of users
#'
#' @export
getUsers <- function(sourceURL, experimentName, auth = FALSE){
    request <- checkAuthentication("users", auth)
    res <- API.request(request = request$request,
                       params = list(
                           sourceurl = sourceURL,
                           experimentName = experimentName
                       ),
                       auth = request$auth)
    read.table(text = res, header = TRUE)
}

